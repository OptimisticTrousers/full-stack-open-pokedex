name: Render Deploy
on:
  push:
    branches:
      - main
env:
  CONDITION: ${{ contains(github.event.head_commit.message, '#skip') }}
jobs:
  deploy:
    name: Deploy app
    if: ${{ github.env.CONDITION == 'false' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Wait for Render deployment
        uses: bounceapp/render-action@0.12.0
        with:
          render-token: ${{ secrets.RENDER_TOKEN }}
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          retries: 3
          wait: 16000
          sleep: 30000
      - name: The job has succeeded
        uses: rjstone/discord-webhook-notify@v2
        if: ${{ success() }}
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
          severity: info
          text: A new version of Pokedex deployed
          description: to https://full-stack-open-pokedex-patient-dew-8026.fly.dev/ by ${{ github.event.head_commit.committer.username }}
      - name: The job has failed
        uses: rjstone/discord-webhook-notify@v2
        if: ${{ failure() }}
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
          severity: error
          text: Build failed
          description: commit ${{ github.event.head_commit.url }} by ${{ github.event.head_commit.committer.username }} broke the build :()
